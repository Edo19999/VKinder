# DatabaseRepository ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–≠—Ç–æ—Ç –∫–ª–∞—Å—Å –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Å PostgreSQL –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ VKinder Bot.  
–û–Ω —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, —Ñ–æ—Ç–æ, –∏–∑–±—Ä–∞–Ω–Ω—ã–º, –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–º–∏ –ø—Ä–æ—Ñ–∏–ª—è–º–∏, —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.

---

## üìå –ú–µ—Ç–æ–¥—ã –∫–ª–∞—Å—Å–∞

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- **__init__()** ‚Äî —Å–æ–∑–¥–∞—ë—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.
- **_create_connection()** ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL.  
  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ `config.DATABASE`.

### –†–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- **add_or_update_user(user: VKUser) -> bool**  
  –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ (–ø–æ vk_user_id).

- **get_user_by_vk_id(vk_id: int) -> Optional[VKUser]**  
  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç `VKUser` –ø–æ –µ–≥–æ ID –∏–ª–∏ `None`.

### –†–∞–±–æ—Ç–∞ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏
- **add_user_photos(vk_id: int, photos: List[Tuple[str, int]]) -> bool**  
  –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Ñ–æ—Ç–æ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–µ (url + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∞–π–∫–æ–≤).

- **get_user_photos(vk_id: int) -> List[UserPhoto]**  
  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –ª–∞–π–∫–∞–º.

### –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏
- **add_to_favorites(user_id: int, favorite_vk_id: int) -> bool**  
  –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ (–±–µ–∑ –¥—É–±–ª–µ–π).

- **get_favorites(user_id: int) -> List[Tuple]**  
  –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö (id, –∏–º—è, —Ñ–∞–º–∏–ª–∏—è, —Å—Å—ã–ª–∫–∞).

- **get_favorites_with_details(user_id: int) -> List[tuple]**  
  –¢–æ –∂–µ —Å–∞–º–æ–µ, –Ω–æ —Å –¥–∞—Ç–æ–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ –∑–∞–º–µ—Ç–∫–∞–º–∏.

- **remove_from_favorites(user_id: int, favorite_vk_id: int) -> bool**  
  –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ.

- **update_favorite_notes(user_id: int, favorite_vk_id: int, notes: str) -> bool**  
  –î–æ–±–∞–≤–ª—è–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–º–µ—Ç–∫—É –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏
- **add_to_viewed(user_id: int, viewed_vk_id: int) -> bool**  
  –î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å.

- **get_viewed_users(user_id: int) -> List[int]**  
  –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π.

### –°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (FSM)
- **update_user_state(user_id: int, state: str, state_data: Optional[dict]) -> bool**  
  –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å –¥–∞–Ω–Ω—ã–º–∏).

- **get_user_state(user_id: int) -> Optional[UserState]**  
  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç `UserState` –∏–ª–∏ `None`.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **save_user_preferences(user_id: int, preferences: Dict[str, Any]) -> bool**  
  –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è (–≥–æ—Ä–æ–¥, –≤–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª –∏ —Ç.–ø.).

- **get_user_preferences(user_id: int) -> Optional[Dict[str, Any]]**  
  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è (—Å–ª–æ–≤–∞—Ä—å).

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- **add_found_user(user_data: Dict[str, Any]) -> bool**  
  –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –≤ —Ç–∞–±–ª–∏—Ü—É vk_found_users (—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º).

- **get_found_user(vk_id: int) -> Optional[tuple]**  
  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (id, –∏–º—è, —Ñ–∞–º–∏–ª–∏—è, —Å—Å—ã–ª–∫–∞).

### –†–µ–π—Ç–∏–Ω–≥–∏ –∏ —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
- **add_user_rating(user_id: int, rated_vk_id: int, rating_type: str) -> bool**  
  –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ü–µ–Ω–∫—É –ø—Ä–æ—Ñ–∏–ª—è (like/dislike/blacklist).

- **get_user_rating(user_id: int, rated_vk_id: int) -> Optional[str]**  
  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–∏–ø –æ—Ü–µ–Ω–∫–∏ (–∏–ª–∏ None).

- **get_rated_users(user_id: int, rating_type: str) -> List[int]**  
  –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ—Ü–µ–Ω—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω `rating_type` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ—Ö.

- **get_blacklisted_users(user_id: int) -> List[int]**  
  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —á—ë—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞.

### –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
- **close()**  
  –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.

---

## ‚öôÔ∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
```python
repo = DatabaseRepository()

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user = VKUser(vk_id=1, first_name="Ivan", last_name="Ivanov")
repo.add_or_update_user(user)

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
state = repo.get_user_state(1)

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ
repo.add_user_photos(1, [("http://photo.url/1.jpg", 100)])

# –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
repo.close()
```
